<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haley</title>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #14141a;
            --bg-tertiary: #1e1e26;
            --text-primary: #ffffff;
            --text-secondary: #a0a0b0;
            --accent: #ff006e;
            --accent-gradient: linear-gradient(135deg, #ff006e, #8338ec);
            --border: rgba(255, 255, 255, 0.1);
            --user-msg-bg: #2a2a35;
        }

        /* Light theme */
        :root.light {
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e8e8ec;
            --text-primary: #1a1a1a;
            --text-secondary: #666666;
            --accent: #ff006e;
            --accent-gradient: linear-gradient(135deg, #ff006e, #8338ec);
            --border: rgba(0, 0, 0, 0.1);
            --user-msg-bg: #e1e1e8;
        }

        /* Auto-detect system preference */
        @media (prefers-color-scheme: light) {
            :root:not(.dark) {
                --bg-primary: #f5f5f7;
                --bg-secondary: #ffffff;
                --bg-tertiary: #e8e8ec;
                --text-primary: #1a1a1a;
                --text-secondary: #666666;
                --accent: #ff006e;
                --accent-gradient: linear-gradient(135deg, #ff006e, #8338ec);
                --border: rgba(0, 0, 0, 0.1);
                --user-msg-bg: #e1e1e8;
            }
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            overflow: hidden;
        }

        /* Auth Overlay */
        .auth-overlay {
            position: fixed;
            inset: 0;
            background: var(--bg-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .auth-overlay.hidden {
            display: none;
        }

        .auth-box {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 360px;
            width: 90%;
        }

        .auth-box h2 {
            font-size: 1.5rem;
            margin-bottom: 8px;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-box p {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 24px;
        }

        .auth-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            margin-bottom: 16px;
        }

        .auth-input:focus {
            border-color: var(--accent);
        }

        .auth-btn {
            width: 100%;
            padding: 12px;
            background: var(--accent-gradient);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .auth-btn:hover {
            transform: scale(1.02);
        }

        .auth-error {
            color: var(--accent);
            font-size: 0.85rem;
            margin-top: 12px;
            display: none;
        }

        /* Chat Container */
        .chat-container {
            display: none;
            flex-direction: column;
            height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            padding-top: 56px; /* Space for fixed header */
            padding-bottom: 80px; /* Space for fixed input */
        }

        .chat-container.visible {
            display: flex;
        }

        /* Adjust for mobile safe area */
        @supports (padding: env(safe-area-inset-bottom)) {
            .chat-container {
                padding-bottom: calc(80px + env(safe-area-inset-bottom));
            }
        }

        /* Header - Fixed at top */
        .chat-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            height: 56px;
        }

        .chat-header h1 {
            font-size: 1.2rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .trusted-badge {
            font-size: 0.75rem;
            color: #39ff14;
            background: rgba(57, 255, 20, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid rgba(57, 255, 20, 0.3);
        }

        .theme-toggle {
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .theme-toggle:hover {
            background: var(--bg-tertiary);
            color: var(--accent);
        }

        .status {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #39ff14;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Messages Area - MAX WIDTH FOR PC */
        .messages {
            flex: 1;
            overflow-y: auto;
            padding: 76px 20px 100px 20px; /* top for header, bottom for input */
            margin-top: 0;
        }

        .messages-inner {
            max-width: 48rem;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        /* Message Container */
        .message-container {
            display: flex;
            flex-direction: column;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-container.user {
            align-items: flex-end;
        }

        .message-header {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
            letter-spacing: 0.01em;
        }

        .message-container.user .message-header {
            text-align: right;
        }

        .message-content {
            position: relative;
            font-size: 16px;
            line-height: 1.7;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        /* User Message Bubble */
        .message-container.user .message-content {
            background: var(--user-msg-bg);
            padding: 12px 16px;
            border-radius: 18px;
            max-width: 80%;
            color: var(--text-primary);
        }

        /* Assistant Message */
        .message-container.assistant .message-content {
            color: var(--text-primary);
            padding-right: 50px;
        }

        /* Speaker Button */
        .speaker-btn {
            position: absolute;
            right: 0;
            bottom: 0;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 12px;
            font-size: 1.5rem;
            opacity: 0.7;
            transition: all 0.2s;
            border-radius: 8px;
        }

        .speaker-btn:hover {
            opacity: 1;
            color: var(--accent);
            background: rgba(255, 0, 110, 0.1);
        }

        .speaker-btn.loading {
            animation: pulse-speaker 0.8s infinite;
            color: var(--accent);
        }

        .speaker-btn.playing {
            color: #39ff14;
            background: rgba(57, 255, 20, 0.1);
        }

        @keyframes pulse-speaker {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 0;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* Input Area - Fixed at bottom */
        .input-area {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 12px 16px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding-bottom: max(12px, env(safe-area-inset-bottom));
        }

        .input-area-inner {
            max-width: 48rem;
            margin: 0 auto;
        }

        /* File Preview Chips */
        .file-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 12px;
        }

        .file-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: rgba(255, 0, 110, 0.15);
            border-radius: 16px;
            font-size: 13px;
        }

        .file-chip button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 16px;
            padding: 0;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .file-chip button:hover {
            color: var(--accent);
        }

        /* Input Row */
        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 12px;
        }

        /* Voice controls group - mic and send together */
        .voice-controls {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
        }

        .btn-icon {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-size: 20px;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .btn-icon:hover {
            background: var(--accent);
        }

        .btn-plus {
            background: var(--accent-gradient);
        }

        .btn-plus:hover {
            transform: scale(1.05);
        }

        .btn-mic.recording {
            background: var(--accent);
            animation: pulse-red 1s infinite;
        }

        @keyframes pulse-red {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .btn-send {
            background: var(--accent-gradient);
        }

        .btn-send:hover {
            transform: scale(1.05);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .input-wrapper {
            flex: 1;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 24px;
            padding: 12px 16px;
            display: flex;
            align-items: center;
        }

        .input-wrapper:focus-within {
            border-color: var(--accent);
        }

        #messageInput {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 16px;
            outline: none;
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        #messageInput::placeholder {
            color: var(--text-secondary);
        }

        .recording-time {
            font-size: 0.75rem;
            color: var(--accent);
            margin-left: 8px;
            font-family: monospace;
            min-width: 40px;
        }

        /* Reconnecting Overlay */
        .reconnecting-overlay {
            position: fixed;
            inset: 0;
            background: rgba(10, 10, 15, 0.95);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            gap: 20px;
        }

        .reconnecting-overlay.visible {
            display: flex;
        }

        .reconnecting-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .reconnecting-text {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Mobile Adjustments */
        @media (max-width: 768px) {
            body {
                overflow-x: hidden;
            }

            .messages {
                padding: 68px 12px 90px 12px; /* top for fixed header, bottom for fixed input */
            }

            .messages-inner {
                max-width: 100%;
                width: 100%;
            }

            .chat-header {
                padding: 10px 12px;
                height: 52px;
            }

            .input-area {
                padding: 8px 10px;
            }

            .input-area-inner {
                max-width: 100%;
                width: 100%;
            }

            .input-row {
                gap: 8px;
            }

            .voice-controls {
                gap: 2px;
            }

            .btn-icon {
                width: 44px;
                height: 44px;
                min-width: 44px;
                flex-shrink: 0;
            }

            .btn-icon svg {
                width: 20px;
                height: 20px;
            }

            .input-wrapper {
                padding: 8px 12px;
                min-width: 0; /* Allow shrinking */
                flex: 1;
            }

            #messageInput {
                font-size: 16px; /* Prevent zoom on iOS */
                width: 100%;
            }

            .message-container.user .message-content {
                max-width: 85%;
            }

            .chat-header h1 {
                font-size: 1.1rem;
            }

            .header-right {
                gap: 8px;
            }

            .trusted-badge {
                font-size: 0.65rem;
                padding: 2px 6px;
            }

            .trusted-badge svg {
                width: 10px;
                height: 10px;
            }

            .recording-time {
                font-size: 0.7rem;
                min-width: 30px;
            }

            .file-chips {
                gap: 6px;
            }

            .file-chip {
                padding: 4px 8px;
                font-size: 12px;
            }
        }

        /* Hidden file input */
        .hidden-file-input {
            display: none;
        }
    </style>
</head>
<body>
    <!-- Auth Overlay -->
    <div class="auth-overlay" id="authOverlay">
        <div class="auth-box">
            <h2>Haley</h2>
            <p>Enter password to continue</p>
            <input type="password" class="auth-input" id="authPassword" placeholder="Password" onkeydown="if(event.key==='Enter')authenticate()">
            <button class="auth-btn" onclick="authenticate()">Enter</button>
            <div class="auth-error" id="authError">Incorrect password. Try again.</div>
        </div>
    </div>

    <!-- Reconnecting Overlay -->
    <div class="reconnecting-overlay" id="reconnectingOverlay">
        <div class="reconnecting-spinner"></div>
        <div class="reconnecting-text">Reconnecting to HaleyOS<span class="dots">...</span></div>
    </div>

    <!-- Chat Container -->
    <div class="chat-container" id="chatContainer">
        <div class="chat-header">
            <h1>Haley</h1>
            <div class="header-right">
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle theme">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                </button>
                <span class="trusted-badge" id="trustedBadge" style="display: none;"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="vertical-align: middle; margin-right: 4px;"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>Remembered</span>
                <div class="status">
                    <div class="status-dot"></div>
                    <span id="statusText">Online</span>
                </div>
            </div>
        </div>

        <div class="messages" id="messages">
            <div class="messages-inner" id="messagesInner">
                <div class="message-container assistant">
                    <div class="message-header">Haley</div>
                    <div class="message-content">
                        Hey! I'm Haley. Text me, upload files, or hold the mic to talk. What's up?
                        <button class="speaker-btn" onclick="speak('Hey! I\'m Haley. Text me, upload files, or hold the mic to talk. What\'s up?', this)"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg></button>
                    </div>
                </div>
            </div>
        </div>

        <div class="input-area">
            <div class="input-area-inner">
                <!-- File Chips -->
                <div class="file-chips" id="fileChips"></div>

                <!-- Input Row -->
                <div class="input-row">
                    <!-- Plus/Upload Button -->
                    <button class="btn-icon btn-plus" onclick="document.getElementById('fileInput').click()" title="Upload file">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </button>
                    <input type="file" id="fileInput" class="hidden-file-input" accept="image/*,.pdf,.txt,.zip" multiple onchange="handleFiles(this.files)">

                    <!-- Text Input -->
                    <div class="input-wrapper">
                        <textarea id="messageInput" placeholder="Message Haley..." rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
                    </div>

                    <!-- Voice controls group - mic and send together -->
                    <div class="voice-controls">
                        <button class="btn-icon btn-mic" id="micBtn" onmousedown="startRecording()" onmouseup="stopRecording()" onmouseleave="stopRecording()" ontouchstart="startRecording()" ontouchend="stopRecording()" title="Hold to record">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        </button>
                        <span class="recording-time" id="recordingTime"></span>
                        <button class="btn-icon btn-send" id="sendBtn" onclick="sendMessage()" title="Send">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.location.origin + '/api';
        const messagesInner = document.getElementById('messagesInner');
        const messageInput = document.getElementById('messageInput');
        const micBtn = document.getElementById('micBtn');
        const recordingTime = document.getElementById('recordingTime');
        const fileChips = document.getElementById('fileChips');
        const sendBtn = document.getElementById('sendBtn');

        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        let recordingInterval = null;
        let recordingSeconds = 0;
        let selectedFiles = [];
        let currentAudio = null;
        let isSpeaking = false;

        // Browser Fingerprint
        function generateFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Haley fingerprint', 2, 2);
            
            const data = [
                navigator.userAgent,
                navigator.language,
                screen.colorDepth,
                screen.availWidth + 'x' + screen.availHeight,
                new Date().getTimezoneOffset(),
                !!window.sessionStorage,
                !!window.localStorage,
                canvas.toDataURL(),
                navigator.hardwareConcurrency || 'unknown',
                navigator.platform
            ].join('###');
            
            let hash = 0;
            for (let i = 0; i < data.length; i++) {
                const char = data.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'fp_' + Math.abs(hash).toString(16);
        }

        const DEVICE_FINGERPRINT = generateFingerprint();

        // Auth Functions
        async function authenticate() {
            const password = document.getElementById('authPassword').value;
            const errorEl = document.getElementById('authError');
            errorEl.style.display = 'none';

            try {
                const res = await fetch(`${API_URL}/auth`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password, fingerprint: DEVICE_FINGERPRINT })
                });
                const data = await res.json();
                if (data.valid) {
                    sessionStorage.setItem('haley_auth', 'true');
                    if (data.cookie) localStorage.setItem('haley_auth_cookie', data.cookie);
                    localStorage.setItem('haley_fingerprint', DEVICE_FINGERPRINT);
                    if (data.ip) localStorage.setItem('haley_trusted_ip', data.ip);
                    showChat();
                } else {
                    errorEl.style.display = 'block';
                }
            } catch (e) {
                errorEl.style.display = 'block';
            }
        }

        function showChat() {
            document.getElementById('authOverlay').style.display = 'none';
            document.getElementById('chatContainer').classList.add('visible');
            const badge = document.getElementById('trustedBadge');
            if (badge && localStorage.getItem('haley_trusted_ip')) badge.style.display = 'inline';
            loadHistory();
            startConnectionMonitoring();
        }

        async function checkAuth() {
            if (sessionStorage.getItem('haley_auth') === 'true') {
                showChat();
                return;
            }

            const cookieExpires = localStorage.getItem('haley_auth_cookie_expires');
            if (cookieExpires && new Date(cookieExpires) < new Date()) {
                localStorage.removeItem('haley_auth_cookie');
                localStorage.removeItem('haley_auth_cookie_expires');
            }

            try {
                const headers = { 'Content-Type': 'application/json' };
                headers['x-device-fingerprint'] = DEVICE_FINGERPRINT;
                const cookie = localStorage.getItem('haley_auth_cookie') || '';
                if (cookie) headers['x-auth-cookie'] = cookie;

                const res = await fetch(`${API_URL}/check-auth`, { headers });
                const data = await res.json();
                if (data.trusted) {
                    sessionStorage.setItem('haley_auth', 'true');
                    showChat();
                }
            } catch (e) {
                console.log('Auth check failed');
            }
        }

        // Session tracking for conversation memory
        let sessionId = sessionStorage.getItem('haley_session_id') || null;
        let isSending = false;

        // Fetch and display build version
        fetch('/health').then(r => r.json()).then(d => {
            if (d.version) document.getElementById('statusText').textContent = 'v' + d.version;
        }).catch(() => {});

        // Connection Monitoring
        let isConnected = false;
        async function checkConnection() {
            try {
                const res = await fetch(`${API_URL}/health`, { signal: AbortSignal.timeout(5000) });
                const wasConnected = isConnected;
                isConnected = res.ok;
                const overlay = document.getElementById('reconnectingOverlay');
                if (isConnected && !wasConnected) {
                    overlay.classList.remove('visible');
                } else if (!isConnected && wasConnected) {
                    overlay.classList.add('visible');
                }
            } catch (e) {
                if (isConnected) {
                    isConnected = false;
                    document.getElementById('reconnectingOverlay').classList.add('visible');
                }
            }
        }

        function startConnectionMonitoring() {
            checkConnection();
            setInterval(checkConnection, 10000);
        }

        // File Handling
        function handleFiles(files) {
            selectedFiles = Array.from(files);
            updateFileChips();
        }

        function updateFileChips() {
            fileChips.innerHTML = '';
            selectedFiles.forEach((file, index) => {
                const chip = document.createElement('div');
                chip.className = 'file-chip';
                chip.innerHTML = `
                    <span>${file.name}</span>
                    <button onclick="removeFile(${index})">Ã—</button>
                `;
                fileChips.appendChild(chip);
            });
        }

        function removeFile(index) {
            selectedFiles.splice(index, 1);
            updateFileChips();
        }

        // Chat Functions
        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        function handleKeyDown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        }

        function addMessage(text, role) {
            const container = document.createElement('div');
            container.className = `message-container ${role}`;
            
            const header = document.createElement('div');
            header.className = 'message-header';
            header.textContent = role === 'user' ? 'You' : 'Haley';
            
            const content = document.createElement('div');
            content.className = 'message-content';
            content.textContent = text;
            
            if (role === 'assistant') {
                const btn = document.createElement('button');
                btn.className = 'speaker-btn';
                btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>';
                btn.onclick = function() { speak(text, this); };
                content.appendChild(btn);
            }
            
            container.appendChild(header);
            container.appendChild(content);
            messagesInner.appendChild(container);
            container.scrollIntoView({ behavior: 'smooth', block: 'end' });
            return container;
        }

        function showTyping() {
            const container = document.createElement('div');
            container.className = 'message-container assistant';
            container.id = 'typing';
            container.innerHTML = `
                <div class="message-header">Haley</div>
                <div class="typing-indicator"><span></span><span></span><span></span></div>
            `;
            messagesInner.appendChild(container);
            container.scrollIntoView({ behavior: 'smooth', block: 'end' });
        }

        function hideTyping() {
            const typing = document.getElementById('typing');
            if (typing) typing.remove();
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text && selectedFiles.length === 0) return;
            if (isSending) return;

            isSending = true;
            sendBtn.disabled = true;

            // Upload files if any
            if (selectedFiles.length > 0) {
                for (const file of selectedFiles) {
                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        await fetch(`${API_URL}/upload`, { method: 'POST', body: formData });
                    } catch (e) {
                        console.error('Upload failed:', e);
                    }
                }
                selectedFiles = [];
                updateFileChips();
            }

            if (text) {
                addMessage(text, 'user');
                messageInput.value = '';
                messageInput.style.height = 'auto';
                showTyping();

                try {
                    const body = { message: text };
                    if (sessionId) body.session_id = sessionId;

                    const res = await fetch(`${API_URL}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    hideTyping();
                    const data = await res.json();

                    if (data.session_id) {
                        sessionId = data.session_id;
                        sessionStorage.setItem('haley_session_id', sessionId);
                    }

                    if (data.response) addMessage(data.response, 'assistant');
                } catch (e) {
                    hideTyping();
                    addMessage('Sorry, something went wrong. Try again?', 'assistant');
                } finally {
                    isSending = false;
                    sendBtn.disabled = false;
                    messageInput.focus();
                    return;
                }
            }

            isSending = false;
            sendBtn.disabled = false;
        }

        async function loadHistory() {
            try {
                const res = await fetch(`${API_URL}/history`);
                const data = await res.json();
                if (data.messages && data.messages.length > 0) {
                    messagesInner.innerHTML = '';
                    data.messages.forEach(msg => {
                        if (msg.role === 'user') addMessage(msg.content, 'user');
                        else if (msg.role === 'assistant') addMessage(msg.content, 'assistant');
                    });
                }
            } catch (e) {
                console.log('Failed to load history');
            }
        }

        // Voice/TTS Functions
        async function speak(text, btn) {
            if (isSpeaking && currentAudio) {
                currentAudio.pause();
                currentAudio = null;
                isSpeaking = false;
                if (btn) btn.classList.remove('playing', 'loading');
                return;
            }

            if (btn) btn.classList.add('loading');

            try {
                const res = await fetch(`${API_URL}/speak`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });

                if (!res.ok) {
                    console.error('TTS failed:', res.status);
                    if (btn) btn.classList.remove('loading');
                    return;
                }

                const contentType = res.headers.get('content-type') || '';
                if (!contentType.includes('audio')) {
                    console.error('TTS returned non-audio:', contentType);
                    if (btn) btn.classList.remove('loading');
                    return;
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                currentAudio = new Audio(url);
                isSpeaking = true;

                if (btn) {
                    btn.classList.remove('loading');
                    btn.classList.add('playing');
                }

                currentAudio.onended = () => {
                    isSpeaking = false;
                    currentAudio = null;
                    URL.revokeObjectURL(url);
                    if (btn) btn.classList.remove('playing');
                };

                currentAudio.onerror = (e) => {
                    isSpeaking = false;
                    currentAudio = null;
                    URL.revokeObjectURL(url);
                    if (btn) btn.classList.remove('playing', 'loading');
                    console.error('Audio playback error:', e);
                };

                // Handle autoplay policy - play() returns a promise
                try {
                    const playPromise = currentAudio.play();
                    if (playPromise !== undefined) {
                        await playPromise;
                        console.log('Audio playback started');
                    }
                } catch (playError) {
                    console.error('Autoplay blocked or playback failed:', playError);
                    isSpeaking = false;
                    currentAudio = null;
                    URL.revokeObjectURL(url);
                    if (btn) {
                        btn.classList.remove('playing', 'loading');
                        // Show visual feedback that autoplay is blocked
                        btn.style.color = '#ff4444';
                        setTimeout(() => { btn.style.color = ''; }, 2000);
                    }
                }
            } catch (e) {
                console.error('TTS error:', e);
                isSpeaking = false;
                currentAudio = null;
                if (btn) btn.classList.remove('loading', 'playing');
            }
        }

        async function startRecording() {
            if (isRecording) return;
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];
                recordingSeconds = 0;

                mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
                mediaRecorder.onstop = async () => {
                    const blob = new Blob(audioChunks, { type: 'audio/webm' });
                    stream.getTracks().forEach(t => t.stop());
                    showTyping();
                    try {
                        const formData = new FormData();
                        formData.append('audio', blob, 'voice.webm');
                        const res = await fetch(`${API_URL}/transcribe`, { method: 'POST', body: formData });
                        hideTyping();
                        const data = await res.json();
                        if (data.text) {
                            messageInput.value = data.text;
                            sendMessage();
                        }
                    } catch (e) {
                        hideTyping();
                        addMessage("Couldn't understand that. Try again?", 'assistant');
                    }
                };

                mediaRecorder.start();
                isRecording = true;
                micBtn.classList.add('recording');
                recordingInterval = setInterval(() => {
                    recordingSeconds++;
                    const m = Math.floor(recordingSeconds / 60);
                    const s = recordingSeconds % 60;
                    recordingTime.textContent = `${m}:${s.toString().padStart(2, '0')}`;
                }, 1000);
            } catch (e) {
                console.error('Mic error:', e);
            }
        }

        function stopRecording() {
            if (!isRecording || !mediaRecorder) return;
            mediaRecorder.stop();
            isRecording = false;
            micBtn.classList.remove('recording');
            clearInterval(recordingInterval);
            recordingTime.textContent = '';
        }

        // Theme toggle
        function toggleTheme() {
            const isLight = document.documentElement.classList.toggle('light');
            localStorage.setItem('haley_theme', isLight ? 'light' : 'dark');
            updateThemeIcon(isLight);
        }

        function updateThemeIcon(isLight) {
            const btn = document.getElementById('themeToggle');
            if (btn) {
                btn.innerHTML = isLight 
                    ? '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>'
                    : '<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>';
            }
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('haley_theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'light' || (!savedTheme && !prefersDark)) {
            document.documentElement.classList.add('light');
            updateThemeIcon(true);
        } else {
            updateThemeIcon(false);
        }

        // Init
        checkAuth();
    </script>
</body>
</html>
